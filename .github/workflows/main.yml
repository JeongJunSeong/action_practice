name: CI/CD Pipeline with VPN and Self-hosted Runner

on:
  push:
    branches:
      - main  # main 브랜치에 코드가 푸시될 때 실행
      
jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      - name: Start OpenVPN
        run: |
          & "C:\Program Files\OpenVPN\bin\openvpn.exe" `
          --config "C:\Users\edu\Downloads\openvpn01-TCP4-1188-config.ovpn" `
          --auth-user-pass "C:\Users\edu\Downloads\vpn-auth.txt" `
          --daemon


      - name: Deploy to GPU server
        run: |
          ssh -i "C:\Users\edu\Downloads\jjs_490.pem" -p 32643 root@10.196.197.2 << EOF
            # GPU 서버에서 작업 실행
            cd /data/ephemeral/home
            echo "Hello from GitHub Actions!" > github_actions_test.txt
          EOF

      - name: Run tests
        run: |
          pytest tests/
